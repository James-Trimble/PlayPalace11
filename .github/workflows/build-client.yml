name: Build Client

on:
  push:
    branches: [main]
    paths:
      - 'client/**'
      - '.github/workflows/build-client.yml'

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller
        cd client
        pip install -e .
    
    - name: Get version from pyproject.toml
      id: get_version
      run: |
        $version = (Select-String -Path "client/pyproject.toml" -Pattern 'version = "(.+)"').Matches[0].Groups[1].Value
        echo "VERSION=$version" >> $env:GITHUB_OUTPUT
        echo "Version: $version"
    
    - name: Build with PyInstaller
      run: |
        cd client
        pyinstaller --noconfirm --onedir --windowed --name "PlayPalace" `
          --add-data "sounds;sounds" `
          --hidden-import "accessible_output2.outputs.auto" `
          --hidden-import "sound_lib" `
          client.py
    
    - name: Create release package
      run: |
        $version = "${{ steps.get_version.outputs.VERSION }}"
        Compress-Archive -Path "client/dist/PlayPalace/*" -DestinationPath "PlayPalace-$version.zip"
    
    - name: Upload to server
      env:
        SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
        SERVER_HOST: ${{ secrets.SERVER_HOST }}
        SERVER_USER: ${{ secrets.SERVER_USER }}
      run: |
        $version = "${{ steps.get_version.outputs.VERSION }}"
        
        # Save SSH key
        $sshDir = "$env:USERPROFILE\.ssh"
        New-Item -ItemType Directory -Force -Path $sshDir | Out-Null
        $env:SSH_PRIVATE_KEY | Out-File -FilePath "$sshDir\deploy_key" -Encoding ASCII
        
        # Upload zip
        scp -i "$sshDir\deploy_key" -o StrictHostKeyChecking=no `
          "PlayPalace-$version.zip" `
          "${env:SERVER_USER}@${env:SERVER_HOST}:/var/www/playpalace/downloads/"
        
        # Update latest.json with version info
        $json = @{
          version = $version
          download_url = "https://playpalace.dev/downloads/PlayPalace-$version.zip"
          changelog = "Automatic build from commit ${{ github.sha }}"
          build_date = Get-Date -Format "o"
        } | ConvertTo-Json
        
        $json | ssh -i "$sshDir\deploy_key" -o StrictHostKeyChecking=no `
          "${env:SERVER_USER}@${env:SERVER_HOST}" `
          "cat > /var/www/playpalace/downloads/latest.json"
        
        # Clean up key
        Remove-Item "$sshDir\deploy_key"
    
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ steps.get_version.outputs.VERSION }}
        name: PlayPalace v${{ steps.get_version.outputs.VERSION }}
        files: PlayPalace-${{ steps.get_version.outputs.VERSION }}.zip
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
